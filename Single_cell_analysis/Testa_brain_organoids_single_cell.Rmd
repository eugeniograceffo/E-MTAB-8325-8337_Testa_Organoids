---
title: "scRNA-Seq Analysis of Brain Organoid dataset from Testa et al 2020"
output: html_notebook
---
## Intro

```{r}
## Load libraries
library(Seurat)
library(harmony)
library(ggplot2)
library(SingleR)
library(dplyr)
library(patchwork)
#library(celldex)
library(RColorBrewer)
library(SingleCellExperiment)
#library(DropletUtils)
#library(usethis)
library(tidyverse)
library(sctransform)
#library(Matrix.utils)
```

# Loading all the datasets separately and performing QC filtering

## 3391B_D50 (day 50) - Sample 1

```{r}
## Load dataset
mat_3391B_D50 <- Read10X("/home/data/Testa_organoids_scRNA/3391B_D50/outs/filtered_feature_bc_matrix")

## Create Seurat object
srat_3391B_D50 <- CreateSeuratObject(counts = mat_3391B_D50, project = "3391B_D50") 

## save up RAM
mat_3391B_D50 <- NULL # saves RAM

## Add the timepoint to the metadata

srat_3391B_D50@meta.data <- srat_3391B_D50@meta.data %>%
  mutate("Timepoint" = as.factor("day_50")) %>%
  relocate("Timepoint", .after="orig.ident") %>%
  rename("Sample"="orig.ident")

head(srat_3391B_D50@meta.data)

## mitochondrial contamination
srat_3391B_D50[["percent.mt"]] <- PercentageFeatureSet(srat_3391B_D50, pattern = "^MT-")

## ribosomial protein (RPS or RPL)
srat_3391B_D50[["percent.rb"]] <- PercentageFeatureSet(srat_3391B_D50, pattern = "^RP[SL]")

## Visualize QC metrics as a violin plot
VlnPlot(srat_3391B_D50, features = c("nFeature_RNA", "nCount_RNA", "percent.mt","percent.rb"), ncol = 4)

```

```{r}
## Let's have a look at the graphs to set the thresholds 

FeatureScatter(srat_3391B_D50, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_hline(yintercept=5, linetype="dashed", color = "blue")
FeatureScatter(srat_3391B_D50, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_hline(yintercept=9000, linetype="dashed", color = "blue") + geom_hline(yintercept=200, linetype="dashed", color = "blue")
#FeatureScatter(srat_3391B_D50, feature1 = "nCount_RNA", feature2 = "percent.rb")
```

```{r}
## apply filters
srat_3391B_D50_filtered <- subset(srat_3391B_D50, subset = nFeature_RNA > 200 & nFeature_RNA < 9000 & percent.mt < 5)
srat_3391B_D50 <- NULL # saves RAM
```




## kolf2c1day50 (day 50) - Sample 2

```{r}
## Load dataset
mat_kolf2c1day50 <- Read10X("/home/data/Testa_organoids_scRNA/kolf2c1day50/outs/filtered_feature_bc_matrix")

## Create Seurat object
srat_kolf2c1day50 <- CreateSeuratObject(counts = mat_kolf2c1day50, project = "kolf2c1day50") 

## save up RAM
mat_kolf2c1day50 <- NULL # saves RAM

## Add the timepoint to the metadata

srat_kolf2c1day50@meta.data <- srat_kolf2c1day50@meta.data %>%
  mutate("Timepoint" = as.factor("day_50")) %>%
  relocate("Timepoint", .after="orig.ident") %>%
  rename("Sample"="orig.ident")

head(srat_kolf2c1day50@meta.data)

## mitochondrial contamination
srat_kolf2c1day50[["percent.mt"]] <- PercentageFeatureSet(srat_kolf2c1day50, pattern = "^MT-")

## ribosomial protein (RPS or RPL)
srat_kolf2c1day50[["percent.rb"]] <- PercentageFeatureSet(srat_kolf2c1day50, pattern = "^RP[SL]")

## Visualize QC metrics as a violin plot
VlnPlot(srat_kolf2c1day50, features = c("nFeature_RNA", "nCount_RNA", "percent.mt","percent.rb"), ncol = 4)

```

```{r}
## Let's have a look at the graphs to set the thresholds 

FeatureScatter(srat_kolf2c1day50, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_hline(yintercept=4, linetype="dashed", color = "blue")
FeatureScatter(srat_kolf2c1day50, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_hline(yintercept=9000, linetype="dashed", color = "blue") + geom_hline(yintercept=200, linetype="dashed", color = "blue")
#FeatureScatter(srat_kolf2c1day50, feature1 = "nCount_RNA", feature2 = "percent.rb")
```

```{r}
## apply filters
srat_kolf2c1day50_filtered <- subset(srat_kolf2c1day50, subset = nFeature_RNA > 200 & nFeature_RNA < 9000 & percent.mt < 4)
srat_kolf2c1day50 <- NULL # saves RAM
```



## G1_MIF1D50 (day 50) - Sample 3

```{r}
## Load dataset
mat_G1_MIF1D50 <- Read10X("/home/data/Testa_organoids_scRNA/G1_MIF1D50/outs/filtered_feature_bc_matrix")

## Create Seurat object
srat_G1_MIF1D50 <- CreateSeuratObject(counts = mat_G1_MIF1D50, project = "G1_MIF1D50") 

## save up RAM
mat_G1_MIF1D50 <- NULL # saves RAM

## Add the timepoint to the metadata

srat_G1_MIF1D50@meta.data <- srat_G1_MIF1D50@meta.data %>%
  mutate("Timepoint" = as.factor("day_50")) %>%
  relocate("Timepoint", .after="orig.ident") %>%
  rename("Sample"="orig.ident")

head(srat_G1_MIF1D50@meta.data)

## mitochondrial contamination
srat_G1_MIF1D50[["percent.mt"]] <- PercentageFeatureSet(srat_G1_MIF1D50, pattern = "^MT-")

## ribosomial protein (RPS or RPL)
srat_G1_MIF1D50[["percent.rb"]] <- PercentageFeatureSet(srat_G1_MIF1D50, pattern = "^RP[SL]")

## Visualize QC metrics as a violin plot
VlnPlot(srat_G1_MIF1D50, features = c("nFeature_RNA", "nCount_RNA", "percent.mt","percent.rb"), ncol = 4)

```

```{r}
## Let's have a look at the graphs to set the thresholds 

FeatureScatter(srat_G1_MIF1D50, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_hline(yintercept=6, linetype="dashed", color = "blue")
FeatureScatter(srat_G1_MIF1D50, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_hline(yintercept=9000, linetype="dashed", color = "blue") + geom_hline(yintercept=200, linetype="dashed", color = "blue")
#FeatureScatter(srat_G1_MIF1D50, feature1 = "nCount_RNA", feature2 = "percent.rb")
```

```{r}
## apply filters
srat_G1_MIF1D50_filtered <- subset(srat_G1_MIF1D50, subset = nFeature_RNA > 200 & nFeature_RNA < 9000 & percent.mt < 6)
srat_G1_MIF1D50 <- NULL # saves RAM
```


## S20271_156 (day 100) - Sample 4

```{r}
## Load dataset
mat_S20271_156 <- Read10X("/home/data/Testa_organoids_scRNA/S20271_156/outs/filtered_feature_bc_matrix")

## Create Seurat object
srat_S20271_156 <- CreateSeuratObject(counts = mat_S20271_156, project = "S20271_156") 

## save up RAM
mat_S20271_156 <- NULL # saves RAM

## Add the timepoint to the metadata

srat_S20271_156@meta.data <- srat_S20271_156@meta.data %>%
  mutate("Timepoint" = as.factor("day_100")) %>%
  relocate("Timepoint", .after="orig.ident") %>%
  rename("Sample"="orig.ident")

head(srat_S20271_156@meta.data)

## mitochondrial contamination
srat_S20271_156[["percent.mt"]] <- PercentageFeatureSet(srat_S20271_156, pattern = "^MT-")

## ribosomial protein (RPS or RPL)
srat_S20271_156[["percent.rb"]] <- PercentageFeatureSet(srat_S20271_156, pattern = "^RP[SL]")

## Visualize QC metrics as a violin plot
VlnPlot(srat_S20271_156, features = c("nFeature_RNA", "nCount_RNA", "percent.mt","percent.rb"), ncol = 4)

```

```{r}
## Let's have a look at the graphs to set the thresholds 

FeatureScatter(srat_S20271_156, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_hline(yintercept=8, linetype="dashed", color = "blue")
FeatureScatter(srat_S20271_156, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_hline(yintercept=9000, linetype="dashed", color = "blue") + geom_hline(yintercept=200, linetype="dashed", color = "blue")
#FeatureScatter(srat_S20271_156, feature1 = "nCount_RNA", feature2 = "percent.rb")
```

```{r}
## apply filters
srat_S20271_156_filtered <- subset(srat_S20271_156, subset = nFeature_RNA > 200 & nFeature_RNA < 9000 & percent.mt < 8)
srat_S20271_156 <- NULL # saves RAM
```



## S20269_154 (day 100) - Sample 5

```{r}
## Load dataset
mat_S20269_154 <- Read10X("/home/data/Testa_organoids_scRNA/S20269_154/outs/filtered_feature_bc_matrix")

## Create Seurat object
srat_S20269_154 <- CreateSeuratObject(counts = mat_S20269_154, project = "S20269_154") 

## save up RAM
mat_S20269_154 <- NULL # saves RAM

## Add the timepoint to the metadata

srat_S20269_154@meta.data <- srat_S20269_154@meta.data %>%
  mutate("Timepoint" = as.factor("day_100")) %>%
  relocate("Timepoint", .after="orig.ident") %>%
  rename("Sample"="orig.ident")

head(srat_S20269_154@meta.data)

## mitochondrial contamination
srat_S20269_154[["percent.mt"]] <- PercentageFeatureSet(srat_S20269_154, pattern = "^MT-")

## ribosomial protein (RPS or RPL)
srat_S20269_154[["percent.rb"]] <- PercentageFeatureSet(srat_S20269_154, pattern = "^RP[SL]")

## Visualize QC metrics as a violin plot
VlnPlot(srat_S20269_154, features = c("nFeature_RNA", "nCount_RNA", "percent.mt","percent.rb"), ncol = 4)

```

```{r}
## Let's have a look at the graphs to set the thresholds 

FeatureScatter(srat_S20269_154, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_hline(yintercept=9, linetype="dashed", color = "blue")
FeatureScatter(srat_S20269_154, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_hline(yintercept=9000, linetype="dashed", color = "blue") + geom_hline(yintercept=200, linetype="dashed", color = "blue")
#FeatureScatter(srat_S20269_154, feature1 = "nCount_RNA", feature2 = "percent.rb")
```

```{r}
## apply filters
srat_S20269_154_filtered <- subset(srat_S20269_154, subset = nFeature_RNA > 200 & nFeature_RNA < 9000 & percent.mt < 9)
srat_S20269_154 <- NULL # saves RAM
```


## S20265_136 (day 100) - Sample 6

```{r}
## Load dataset
mat_S20265_136 <- Read10X("/home/data/Testa_organoids_scRNA/S20265_136/outs/filtered_feature_bc_matrix")

## Create Seurat object
srat_S20265_136 <- CreateSeuratObject(counts = mat_S20265_136, project = "S20265_136") 

## save up RAM
mat_S20265_136 <- NULL # saves RAM

## Add the timepoint to the metadata

srat_S20265_136@meta.data <- srat_S20265_136@meta.data %>%
  mutate("Timepoint" = as.factor("day_100")) %>%
  relocate("Timepoint", .after="orig.ident") %>%
  rename("Sample"="orig.ident")

head(srat_S20265_136@meta.data)

## mitochondrial contamination
srat_S20265_136[["percent.mt"]] <- PercentageFeatureSet(srat_S20265_136, pattern = "^MT-")

## ribosomial protein (RPS or RPL)
srat_S20265_136[["percent.rb"]] <- PercentageFeatureSet(srat_S20265_136, pattern = "^RP[SL]")

## Visualize QC metrics as a violin plot
VlnPlot(srat_S20265_136, features = c("nFeature_RNA", "nCount_RNA", "percent.mt","percent.rb"), ncol = 4)

```

```{r}
## Let's have a look at the graphs to set the thresholds 

FeatureScatter(srat_S20265_136, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_hline(yintercept=10, linetype="dashed", color = "blue")
FeatureScatter(srat_S20265_136, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_hline(yintercept=9000, linetype="dashed", color = "blue") + geom_hline(yintercept=200, linetype="dashed", color = "blue")
#FeatureScatter(srat_S20265_136, feature1 = "nCount_RNA", feature2 = "percent.rb")
```

```{r}
## apply filters
srat_S20265_136_filtered <- subset(srat_S20265_136, subset = nFeature_RNA > 200 & nFeature_RNA < 9000 & percent.mt < 10)
srat_S20265_136 <- NULL # saves RAM
```



## S20276_177 (day 100) - Sample 7

```{r}
## Load dataset
mat_S20276_177 <- Read10X("/home/data/Testa_organoids_scRNA/S20276_177/outs/filtered_feature_bc_matrix")

## Create Seurat object
srat_S20276_177 <- CreateSeuratObject(counts = mat_S20276_177, project = "S20276_177") 

## save up RAM
mat_S20276_177 <- NULL # saves RAM

## Add the timepoint to the metadata

srat_S20276_177@meta.data <- srat_S20276_177@meta.data %>%
  mutate("Timepoint" = as.factor("day_100")) %>%
  relocate("Timepoint", .after="orig.ident") %>%
  rename("Sample"="orig.ident")

head(srat_S20276_177@meta.data)

## mitochondrial contamination
srat_S20276_177[["percent.mt"]] <- PercentageFeatureSet(srat_S20276_177, pattern = "^MT-")

## ribosomial protein (RPS or RPL)
srat_S20276_177[["percent.rb"]] <- PercentageFeatureSet(srat_S20276_177, pattern = "^RP[SL]")

## Visualize QC metrics as a violin plot
VlnPlot(srat_S20276_177, features = c("nFeature_RNA", "nCount_RNA", "percent.mt","percent.rb"), ncol = 4)

```

```{r}
## Let's have a look at the graphs to set the thresholds 

FeatureScatter(srat_S20276_177, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_hline(yintercept=5, linetype="dashed", color = "blue")
FeatureScatter(srat_S20276_177, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_hline(yintercept=9000, linetype="dashed", color = "blue") + geom_hline(yintercept=200, linetype="dashed", color = "blue")
#FeatureScatter(srat_S20276_177, feature1 = "nCount_RNA", feature2 = "percent.rb")
```

```{r}
## apply filters
srat_S20276_177_filtered <- subset(srat_S20276_177, subset = nFeature_RNA > 200 & nFeature_RNA < 9000 & percent.mt < 5)
srat_S20276_177 <- NULL # saves RAM
```



# Merging the filtered datasets together and performing data integration using Harmony
## link -> https://hbctraining.github.io/scRNA-seq_online/lessons/06a_integration_harmony.html

```{r}
## create a list of all the samples
list_filtered_srat <- c( srat_3391B_D50_filtered, srat_kolf2c1day50_filtered, srat_G1_MIF1D50_filtered, srat_S20271_156_filtered, srat_S20269_154_filtered, srat_S20265_136_filtered,srat_S20276_177_filtered)

## merge
merged_seurat <- merge(x = list_filtered_srat[[1]],
		       y = list_filtered_srat[2:length(list_filtered_srat)],
		       merge.data = TRUE)

## save RAM
srat_3391B_D50_filtered <- NULL
srat_kolf2c1day50_filtered <- NULL
srat_G1_MIF1D50_filtered <- NULL
srat_S20271_156_filtered <- NULL
srat_S20269_154_filtered <- NULL
srat_S20265_136_filtered <- NULL
srat_S20276_177_filtered <- NULL


## Let's have a look at the number of cells coming from all the individual samples
table(merged_seurat$Sample)

## Save the merged Seurat object
saveRDS(merged_seurat, "/home/data/Testa_organoids_scRNA/Seurat_code/outputs/merged_dataset_raw.rds")
```



## Perform log-normalization and feature selection, as well as SCT normalization on global object

```{r}
merged_seurat <- merged_seurat %>%
    NormalizeData() %>%
    FindVariableFeatures(selection.method = "vst", nfeatures = 2000) %>% 
    ScaleData() %>%
    SCTransform(vars.to.regress = c("percent.mt"))

# Calculate PCs using variable features determined by SCTransform (3000 by default)
merged_seurat <- RunPCA(merged_seurat, assay = "SCT", npcs = 50)

## Save the merged Seurat object
saveRDS(merged_seurat, "/home/data/Testa_organoids_scRNA/Seurat_code/outputs/merged_dataset_scaled.rds")
```

## Run Harmony
```{r}
harmonized_seurat <- RunHarmony(merged_seurat, 
				group.by.vars = c("Sample", "Timepoint"), 
				reduction = "pca", assay.use = "SCT", reduction.save = "harmony")

## Save the integrated Seurat object
saveRDS(harmonized_seurat, "/home/data/Testa_organoids_scRNA/Seurat_code/outputs/merged_dataset_harmonized.rds")
```


# Dimentionality reduction and UMAP
## Run the computations
```{r}
## harmonized dataset
harmonized_seurat <- RunUMAP(harmonized_seurat, reduction = "harmony", assay = "SCT", dims = 1:50)
harmonized_seurat <- FindNeighbors(object = harmonized_seurat, reduction = "harmony")
harmonized_seurat <- FindClusters(harmonized_seurat, resolution = 0.55)

table(harmonized_seurat@meta.data$seurat_clusters)  #shows the size of each cluster

## Save the integrated Seurat object
saveRDS(harmonized_seurat, "/home/data/Testa_organoids_scRNA/Seurat_code/outputs/merged_dataset_harmonized.rds")


## merged dataset
merged_seurat <- RunUMAP(merged_seurat, reduction = "pca", assay = "SCT", dims = 1:40)
merged_seurat <- FindNeighbors(object = merged_seurat, reduction = "pca")
merged_seurat <- FindClusters(merged_seurat, resolution = 0.5)

table(merged_seurat@meta.data$seurat_clusters)  #shows the size of each cluster

## Save the merged Seurat object
saveRDS(merged_seurat, "/home/data/Testa_organoids_scRNA/Seurat_code/outputs/merged_dataset_scaled.rds")

```
## Plot the two datasets to visualize the difference

```{r}
DimPlot(merged_seurat, reduction="umap", group.by = "Timepoint")
DimPlot(harmonized_seurat, reduction="umap", group.by = "Timepoint")

DimPlot(merged_seurat, reduction="umap", group.by = "Sample")
DimPlot(harmonized_seurat, reduction="umap", group.by = "Sample")
```
# Cluster identification
## Let's plot the clusters
```{r}
DimPlot(merged_seurat,label.size = 4,repel = T,label = T)
DimPlot(harmonized_seurat,label.size = 4,repel = T,label = T)
```
# Annotating the clusters
```{r}
## Some exploration
VlnPlot(harmonized_seurat, features = c("DCX"))
FeaturePlot(harmonized_seurat, features = c("DCX"))
FeaturePlot(harmonized_seurat, features = c("THRA"))
FeaturePlot(harmonized_seurat, features = c("THRA1"))
FeaturePlot(harmonized_seurat, features = c("THRA2"))
VlnPlot(harmonized_seurat, features = c("THRA1"))
VlnPlot(harmonized_seurat, features = c("THRA2"))
```


## Identifying the Markers of each cluster

```{r}
## List of known markers
huCortex_celltype_markers <- list(
  Ex=c("SLC17A7", "CAMK2A","CHN1","SV2B","NRGN"),
  In=c("GAD1", "GAD2", "SLC32A1"),
  Ast=c("GFAP", "AQP4", "SLC4A4"),
  Oli=c("PLP1", "MBP", "MOBP", "MOG"),
  Mic=c("CSF1R", "CD74", "P2RY12"),
  Opc=c("OLIG1", "OLIG2", "PDGFRA", "SOX10", "APOD"),
  Endo=c("ATP10A", "CLDN5", "FLT1", "VWF"),
  Per=c("PTH1R", "SLC6A12", "SLC19A1", "COLEC12", "SLC12A7")
)

## Find the markers within cluster
# find markers for every cluster compared to all remaining cells, report only the positive ones
srat.markers <- FindAllMarkers(harmonized_seurat, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
srat.markers %>%
    group_by(cluster) %>%
    slice_max(n = 3, order_by = avg_log2FC)

```
markers based on atlas https://www.proteinatlas.org/ 

cluster 0 -> STMN2 Excitatory neurons, Horizontal cells, Inhibitory neurons;
            NNAT Muller glia, excitatory neurons;
            NRXN3 nhibitory neurons, Excitatory neurons, Oligodendrocytes;
            
cluster 1 -> PIH1D1 Fibroblasts
            AIMP2 RNA binding
            PLCG2 Plasma cells, Microglial cells, B-cells, NK-cells
            
cluster 11 -> CRABP1 Muller glia cells
            DCC Neurons and oligodendrocytes
            HES6













cluster 1 -> NRN1 endothelial, DDIT4 	T-cells - Immune response
cluster 2 -> NTS 	Endocrine cells, 
            LMO3 (Alveolar cells type 1, Astrocytes, Alveolar cells type 2, Excitatory neurons, Oligodendrocyte precursor cells), RUNX1T1 Inhibitory neurons, Oligodendrocyte precursor cells, Excitatory neurons, Bipolar cells, Microglial cells
cluster 3 -> BHLHE22 Horizontal cells, Bipolar cells; 
              BCL11A dendritic cells, B-cells, Excitatory neurons, Langerhans cells, Basal squamous epithelial cells,               Squamous epithelial cells, Inhibitory neurons; 
              STMN2 Excitatory neurons, Horizontal cells, Inhibitory neurons
cluster 4 -> PTN Endometrial stromal cells, Extravillous trophoblasts, Muller glia cells, Squamous epithelial cells;
            FABP7 Muller glia cells;
            TTYH1 Muller glia cells
Cluster 5 -> Muller glia cells, Late spermatids, Excitatory neurons;
            NHLH1 Oligodendrocytes
            EOMES Intermediate progenitor cells
cluster 6 -> LMO3 Alveolar cells type 1, Astrocytes, Alveolar cells type 2, Excitatory neurons, Oligodendrocyte precursor cells;
            GPR22 Inhibitory neurons, Excitatory neurons;
            GRIA2 Excitatory neurons, Oligodendrocyte precursor cells, Inhibitory neurons, Astrocytes, Oligodendrocytes, Horizontal cells
cluster 7 -> TOP2A Cell cycle regulation;
            CENPF Cell cycle regulation;
            HIST1H4C Cell proliferation
cluster 8 -> CENPF Cell proliferation ;
            PTTG1 Langerhans cells, Spermatocytes;
            KPNA2 Spermatocytes, Cell cycle regulation
cluster 9 -> CRYAB Schwann cells;
            FTL Macrophages;
            HSPA1A Langerhans cells
cluster 10 -> TTR and CLU hepatocytes; 
          CRYAB schwann cells
cluster 11 -> Fibroblasts

```{r}
## Visualize the expression of some markers

FeaturePlot(harmonized_seurat, features = c("SLC17A7", "NRN1", "IGFBP5", "STMN2", "THRA"))

VlnPlot(harmonized_seurat, features = c("SLC17A7", "GAD1", "GFAP", "PLP1", "THRA"))


```

```{r}
## Fibroblasts
VlnPlot(harmonized_seurat, features = c("VIM", "FAP", "COL3A1"))
FeaturePlot(harmonized_seurat, features =c("VIM", "FAP", "COL3A1"))
```



```{r}
## Excitatory neurons
VlnPlot(harmonized_seurat, features = c("SLC17A7", "CAMK2A","CHN1","SV2B","NRGN"))
FeaturePlot(harmonized_seurat, features = c("SLC17A7", "CAMK2A","CHN1","SV2B","NRGN"))
```

```{r}
## Inhibitory neurons
VlnPlot(harmonized_seurat, features = c("GAD1", "GAD2", "SLC32A1"))
FeaturePlot(harmonized_seurat, features = c("GAD1", "GAD2", "SLC32A1"))
```

```{r}
## Astrocytes
VlnPlot(harmonized_seurat, features = c("GFAP", "AQP4", "SLC4A4"))
FeaturePlot(harmonized_seurat, features = c("GFAP", "AQP4", "SLC4A4"))
```
```{r}
## Radial Glia 
VlnPlot(harmonized_seurat, features = c("VIM"))
FeaturePlot(harmonized_seurat, features = c("VIM"))
```

```{r}
## Proliferating Radial Glia 
VlnPlot(harmonized_seurat, features = c("AURKA", "UBEC2C", "TACC3"))
FeaturePlot(harmonized_seurat, features = c("AURKA", "UBEC2C", "TACC3"))
```


```{r}
## Outer Radial Glia 
VlnPlot(harmonized_seurat, features = c("HOPX"))
FeaturePlot(harmonized_seurat, features = c("HOPX"))
```
```{r}
## Choroid 
VlnPlot(harmonized_seurat, features = c("CXCL14", "PLS3", "TTR"))
FeaturePlot(harmonized_seurat, features = c("CXCL14", "PLS3", "TTR"))
```

```{r}
## Intermediate progenitor cells
VlnPlot(harmonized_seurat, features = c("SMOC1", "IFITM3", "HES1"))
FeaturePlot(harmonized_seurat, features = c("SMOC1", "IFITM3", "HES1"))
```


```{r}
## Neurons
VlnPlot(harmonized_seurat, features = c("STMN2", "GNG3", "DCX"))
FeaturePlot(harmonized_seurat, features = c("STMN2", "GNG3", "DCX"))
```
```{r}
## Cortical layer Neurons
VlnPlot(harmonized_seurat, features = c("POU3F2", "RBFOX3", "BCL11B"))
FeaturePlot(harmonized_seurat, features = c("POU3F2", "RBFOX3", "BCL11B"))
```

```{r}
## Cortical upper layer Neurons
VlnPlot(harmonized_seurat, features = c("SATB2", "POU3F2"))
FeaturePlot(harmonized_seurat, features = c("SATB2", "POU3F2"))
```

```{r}
## Visualize heatmap of all the markers (max 20) per cluster
srat.markers %>%
    group_by(cluster) %>%
    top_n(n = 10, wt = avg_log2FC) -> top10
DoHeatmap(srat, features = top10$gene) + NoLegend()
```

## Add new labels
```{r}
new.cluster.ids <- c("Naive CD4 T", "CD14+ Mono", "Memory CD4 T", "B", "CD8 T", "FCGR3A+ Mono",
    "NK", "DC", "Platelet")
names(new.cluster.ids) <- levels(srat)
srat <- RenameIdents(srat, new.cluster.ids)
DimPlot(srat, reduction = "umap", label = TRUE, pt.size = 0.5) + NoLegend()
```






## Regress out Cell cycles
First, we assign each cell a score, based on its expression of G2/M and S phase markers. These marker sets should be anticorrelated in their expression levels, and cells expressing neither are likely not cycling and in G1 phase.

We assign scores in the CellCycleScoring() function, which stores S and G2/M scores in object meta data, along with the predicted classification of each cell in either G2M, S or G1 phase. CellCycleScoring() can also set the identity of the Seurat object to the cell-cycle phase by passing set.ident = TRUE (the original identities are stored as old.ident). Please note that Seurat does not use the discrete classifications (G2M/G1/S) in downstream cell cycle regression. Instead, it uses the quantitative scores for G2M and S phase. However, we provide our predicted classifications in case they are of interest.

```{r}
# Calculate the cell state based on cell cycle markers
s.genes <- cc.genes.updated.2019$s.genes
g2m.genes <- cc.genes.updated.2019$g2m.genes

srat <- CellCycleScoring(srat, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)
table(srat[[]]$Phase)
```
```{r}
# Visualize the distribution of cell cycle markers across
RidgePlot(srat, features = c("PCNA", "TOP2A", "MCM6", "MKI67"), ncol = 2)
```

```{r}
# Running a PCA on cell cycle genes reveals, unsurprisingly, that cells separate entirely by phase

srat <- RunPCA(srat, features = c(s.genes, g2m.genes))
DimPlot(srat)
```
### Normal regression for normal datasets
```{r}
# Let's regress it out
#srat <- ScaleData(srat, vars.to.regress = c("S.Score", "G2M.Score"), features = rownames(srat))

```

### Regression in developmental dataset
The procedure above removes all signal associated with cell cycle. In some cases, we’ve found that this can negatively impact downstream analysis, particularly in differentiating processes (like murine hematopoiesis), where stem cells are quiescent and differentiated cells are proliferating (or vice versa). In this case, regressing out all cell cycle effects can blur the distinction between stem and progenitor cells as well.

As an alternative, we suggest regressing out the difference between the G2M and S phase scores. This means that signals separating non-cycling cells and cycling cells will be maintained, but differences in cell cycle phase among proliferating cells (which are often uninteresting), will be regressed out of the data

```{r}
## done on server, takes >4h
srat$CC.Difference <- srat$S.Score - srat$G2M.Score
srat <- ScaleData(srat, vars.to.regress = "CC.Difference", features = rownames(srat))
```
```{r}
## reload and visual inspection
srat <- readRDS(file = "~/OneDrive - Charité - Universitätsmedizin Berlin/Schuelke_Lab/EG15_RNA_Seq/Brain_organoids_scRNA_Seq/outputs/cortical_organoids_cell_cycle_regressed_out.rds") 

```

```{r}
# Running a PCA on cell cycle genes again, to visualize the effects of regression

srat <- RunPCA(srat, features = c(s.genes, g2m.genes))
DimPlot(srat)
```






```{r}
## save
saveRDS(srat, file = "~/OneDrive - Charité - Universitätsmedizin Berlin/Schuelke_Lab/EG15_RNA_Seq/Brain_organoids_scRNA_Seq/outputs/cortical_organoids_results.rds")
sessionInfo()
```

